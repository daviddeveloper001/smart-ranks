# Smart Ranks API - Sistema de Gesti√≥n de Productos

[![Laravel](https://img.shields.io/badge/Laravel-12.x-red.svg)](https://laravel.com)
[![PHP](https://img.shields.io/badge/PHP-8.2+-blue.svg)](https://php.net)
[![JWT](https://img.shields.io/badge/JWT-Auth-green.svg)](https://jwt-auth.readthedocs.io/)
[![Spatie Permissions](https://img.shields.io/badge/Spatie-Permissions-orange.svg)](https://spatie.be/docs/laravel-permission)

API RESTful desarrollada en Laravel 12 para la gesti√≥n de productos y categor√≠as con sistema de autenticaci√≥n JWT, autorizaci√≥n basada en roles y auditor√≠a completa de cambios.

## üöÄ Caracter√≠sticas Principales

- **Autenticaci√≥n JWT**: Sistema robusto de autenticaci√≥n con tokens JWT
- **Autorizaci√≥n por Roles**: Middleware de roles usando Spatie Laravel Permission
- **Auditor√≠a Autom√°tica**: Sistema de logs autom√°tico con Observers
- **API RESTful**: Endpoints bien estructurados siguiendo convenciones REST
- **Validaci√≥n Robusta**: Validaci√≥n de datos con mensajes de error claros
- **Soft Deletes**: Eliminaci√≥n l√≥gica para preservar integridad de datos
- **Arquitectura Limpia**: Separaci√≥n de responsabilidades con Repositories y Services

## üìã Tabla de Contenidos

- [Configuraci√≥n Local](#configuraci√≥n-local)
- [Endpoints de la API](#endpoints-de-la-api)
- [Autenticaci√≥n y Autorizaci√≥n](#autenticaci√≥n-y-autorizaci√≥n)
- [Colecci√≥n Postman](#colecci√≥n-postman)
- [Documentaci√≥n Swagger](#documentaci√≥n-swagger)
- [Despliegue](#despliegue)
- [Decisiones de Dise√±o](#decisiones-de-dise√±o)
- [Estructura del Proyecto](#estructura-del-proyecto)

## üõ†Ô∏è Configuraci√≥n Local

### Prerrequisitos

- PHP 8.2 o superior
- Composer 2.0 o superior
- MySQL 8.0 o PostgreSQL 12
- Node.js 18+ (para desarrollo frontend)

### Instalaci√≥n

1. **Clonar el repositorio**
```bash
git clone <repository-url>
cd smart-ranks
```

2. **Instalar dependencias**
```bash
composer install
npm install
```

3. **Configurar variables de entorno**
```bash
cp .env.example .env
```

Editar `.env` con tu configuraci√≥n:
```env
APP_NAME="Smart Ranks API"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=smart_ranks
DB_USERNAME=root
DB_PASSWORD=

JWT_SECRET=your-jwt-secret-here
JWT_TTL=60
JWT_REFRESH_TTL=20160
```

4. **Generar claves de aplicaci√≥n**
```bash
php artisan key:generate
php artisan jwt:secret
```

5. **Ejecutar migraciones y seeders**
```bash
php artisan migrate
php artisan db:seed
```

6. **Iniciar el servidor de desarrollo**
```bash
php artisan serve
```

La API estar√° disponible en: `http://localhost:8000`

### Comandos √ötiles

```bash
# Ejecutar tests
php artisan test

# Limpiar cach√©
php artisan config:clear
php artisan cache:clear

# Regenerar autoload
composer dump-autoload
```

## üîå Endpoints de la API

### Autenticaci√≥n y Usuarios

#### POST /api/register
Registra un nuevo usuario.

**Par√°metros:**
```json
{
    "name": "John Doe",
    "email": "john@example.com",
    "password": "password123",
    "password_confirmation": "password123",
    "role": "user" // Opcional, solo para admins
}
```

**Respuesta:**
```json
{
    "success": true,
    "message": "Registration success",
    "data": {
        "user": {
            "id": 1,
            "name": "John Doe",
            "email": "john@example.com"
        },
        "assigned_role": "user"
    }
}
```

#### POST /api/login
Autentica un usuario y devuelve token JWT.

**Par√°metros:**
```json
{
    "email": "john@example.com",
    "password": "password123"
}
```

**Respuesta:**
```json
{
    "message": "Authenticated",
    "user": {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com"
    },
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "token_type": "bearer",
    "expires_in": 3600
}
```

#### POST /api/logout
Invalida el token activo.

**Headers requeridos:**
```
Authorization: Bearer {token}
```

### Gesti√≥n de Productos

#### GET /api/v1/products
Lista todos los productos con paginaci√≥n.

**Headers requeridos:**
```
Authorization: Bearer {token}
```

**Par√°metros de query (opcionales):**
- `page`: N√∫mero de p√°gina
- `per_page`: Elementos por p√°gina
- `search`: B√∫squeda por nombre
- `category_id`: Filtrar por categor√≠a

#### GET /api/v1/products/{id}
Muestra detalle de un producto espec√≠fico.

#### POST /api/v1/products
Crea un nuevo producto (solo Admin).

**Par√°metros:**
```json
{
    "name": "Producto Ejemplo",
    "description": "Descripci√≥n del producto",
    "price": 99.99,
    "stock": 100,
    "category_id": 1
}
```

#### PUT /api/v1/products/{id}
Actualiza un producto existente (solo Admin).

#### DELETE /api/v1/products/{id}
Elimina un producto (solo Admin).

### Gesti√≥n de Categor√≠as

#### GET /api/v1/categories
Lista todas las categor√≠as.

#### GET /api/v1/categories/{id}
Muestra detalle de una categor√≠a.

#### POST /api/v1/categories
Crea una nueva categor√≠a (solo Admin).

**Par√°metros:**
```json
{
    "name": "Electr√≥nicos",
    "description": "Productos electr√≥nicos"
}
```

#### PUT /api/v1/categories/{id}
Actualiza una categor√≠a (solo Admin).

#### DELETE /api/v1/categories/{id}
Elimina una categor√≠a (solo Admin).

## üîê Autenticaci√≥n y Autorizaci√≥n

### Sistema de Roles

El sistema utiliza **Spatie Laravel Permission** para manejar roles y permisos:

- **Admin**: Acceso completo a todos los endpoints
- **User**: Solo lectura de productos y categor√≠as

### Middleware de Autorizaci√≥n

```php
// Rutas protegidas por autenticaci√≥n
Route::middleware(['auth:api'])->group(function () {
    // Rutas de solo lectura
    Route::apiResource('categories', CategoryControllerV1::class)->only(['index', 'show']);
    Route::apiResource('products', ProductControllerV1::class)->only(['index', 'show']);
    
    // Rutas que requieren rol admin
    Route::middleware(['role:admin'])->group(function () {
        Route::apiResource('categories', CategoryControllerV1::class)->only(['store', 'update', 'destroy']);
        Route::apiResource('products', ProductControllerV1::class)->only(['store', 'update', 'destroy']);
    });
});
```

### Manejo de Errores

La API devuelve respuestas consistentes para errores:

```json
{
    "success": false,
    "message": "Unauthorized",
    "errors": {
        "detail": "You do not have permission to perform this action"
    }
}
```

## üìö Colecci√≥n Postman

### Importar Colecci√≥n

1. Descarga el archivo `Smart_Ranks_API.postman_collection.json`
2. Abre Postman
3. Haz clic en "Import"
4. Selecciona el archivo descargado
5. La colecci√≥n se importar√° con todos los endpoints configurados

### Variables de Entorno

Configura las siguientes variables en Postman:

- `base_url`: `http://localhost:8000`
- `token`: Se establece autom√°ticamente despu√©s del login

### Uso de la Colecci√≥n

1. Ejecuta primero el endpoint `POST /api/login`
2. El token se guardar√° autom√°ticamente en la variable `token`
3. Todos los endpoints protegidos usar√°n este token autom√°ticamente

## üìñ Documentaci√≥n Swagger

### Acceso a la Documentaci√≥n

La documentaci√≥n Swagger estar√° disponible en:
```
http://localhost:8000/api/documentation
```

### Caracter√≠sticas

- Documentaci√≥n interactiva de todos los endpoints
- Ejemplos de requests y responses
- Autenticaci√≥n JWT integrada
- Pruebas directas desde el navegador

## üöÄ Despliegue

### URL de Producci√≥n

```
https://smart-ranks-api.herokuapp.com
```

### Variables de Entorno de Producci√≥n

```env
APP_ENV=production
APP_DEBUG=false
APP_URL=https://smart-ranks-api.herokuapp.com

DB_CONNECTION=mysql
DB_HOST=your-production-db-host
DB_DATABASE=smart_ranks_prod
DB_USERNAME=your-db-user
DB_PASSWORD=your-db-password

JWT_SECRET=your-production-jwt-secret
```

### Comandos de Despliegue

```bash
# Optimizar para producci√≥n
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Ejecutar migraciones
php artisan migrate --force
```

## üèóÔ∏è Decisiones de Dise√±o

### 1. Elecci√≥n de Sistema de Roles

**Decisi√≥n**: Uso de **Spatie Laravel Permission** en lugar de enum o tabla simple.

**Justificaci√≥n**:
- **Flexibilidad**: Permite agregar permisos granulares en el futuro
- **Escalabilidad**: F√°cil extensi√≥n para nuevos roles y permisos
- **Mantenibilidad**: Librer√≠a bien mantenida y documentada
- **Integraci√≥n**: Perfecta integraci√≥n con Laravel y JWT

### 2. Middleware de Autorizaci√≥n

**Decisi√≥n**: Middleware `role:admin` personalizado.

**Implementaci√≥n**:
```php
Route::middleware(['role:admin'])->group(function () {
    // Endpoints protegidos
});
```

**Ventajas**:
- Sintaxis clara y legible
- F√°cil de mantener y extender
- Separaci√≥n clara de responsabilidades

### 3. Sistema de Auditor√≠a

**Decisi√≥n**: Implementaci√≥n de Observers para auditor√≠a autom√°tica.

**Caracter√≠sticas**:
- **Autom√°tico**: No requiere c√≥digo adicional en controladores
- **Completo**: Registra creaci√≥n, actualizaci√≥n y eliminaci√≥n
- **Detallado**: Almacena cambios, IP, User Agent
- **Polim√≥rfico**: Funciona con cualquier modelo

**Implementaci√≥n**:
```php
class ProductObserver
{
    public function created(Product $product): void
    {
        $this->log('created', $product);
    }
    
    public function updated(Product $product): void
    {
        $this->log('updated', $product, $product->getChanges());
    }
}
```

### 4. Arquitectura de Capas

**Decisi√≥n**: Separaci√≥n en Repositories, Services y Controllers.

**Estructura**:
```
Controllers/ ‚Üí Services/ ‚Üí Repositories/ ‚Üí Models/
```

**Beneficios**:
- **Testabilidad**: F√°cil mockeo de dependencias
- **Mantenibilidad**: C√≥digo organizado y reutilizable
- **Escalabilidad**: F√°cil agregar nuevas funcionalidades

### 5. Autenticaci√≥n JWT

**Decisi√≥n**: JWT en lugar de tokens de Sanctum.

**Justificaci√≥n**:
- **Stateless**: No requiere almacenamiento en servidor
- **Escalabilidad**: Ideal para APIs distribuidas
- **Performance**: Menor overhead en cada request
- **Flexibilidad**: F√°cil integraci√≥n con frontend

## üìÅ Estructura del Proyecto

```
smart-ranks/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Console/Commands/          # Comandos personalizados
‚îÇ   ‚îú‚îÄ‚îÄ DataTransferObjects/       # DTOs para transferencia de datos
‚îÇ   ‚îú‚îÄ‚îÄ Exceptions/                # Excepciones personalizadas
‚îÇ   ‚îú‚îÄ‚îÄ Filters/                   # Filtros para queries
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/Api/       # Controladores de API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Requests/Api/          # Form Requests de validaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Resources/Api/         # API Resources
‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/                # Interfaces de contratos
‚îÇ   ‚îú‚îÄ‚îÄ Models/                    # Modelos Eloquent
‚îÇ   ‚îú‚îÄ‚îÄ Observers/                 # Observers para auditor√≠a
‚îÇ   ‚îú‚îÄ‚îÄ Repositories/              # Patr√≥n Repository
‚îÇ   ‚îî‚îÄ‚îÄ Services/                  # L√≥gica de negocio
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                # Migraciones de BD
‚îÇ   ‚îú‚îÄ‚îÄ seeders/                   # Seeders de datos
‚îÇ   ‚îî‚îÄ‚îÄ factories/                 # Factories para testing
‚îî‚îÄ‚îÄ routes/
    ‚îú‚îÄ‚îÄ api.php                    # Rutas de autenticaci√≥n
    ‚îî‚îÄ‚îÄ api_v1.php                 # Rutas de API v1
```

## üß™ Testing

### Ejecutar Tests

```bash
# Todos los tests
php artisan test

# Tests espec√≠ficos
php artisan test --filter=ProductTest

# Con coverage
php artisan test --coverage
```

### Estructura de Tests

```
tests/
‚îú‚îÄ‚îÄ Feature/                       # Tests de integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ AuthTest.php
‚îÇ   ‚îú‚îÄ‚îÄ ProductTest.php
‚îÇ   ‚îî‚îÄ‚îÄ CategoryTest.php
‚îî‚îÄ‚îÄ Unit/                         # Tests unitarios
    ‚îú‚îÄ‚îÄ Services/
    ‚îî‚îÄ‚îÄ Repositories/
```

## üîß Configuraci√≥n Adicional

### Logs de Auditor√≠a

Los logs de auditor√≠a se almacenan en la tabla `audit_logs` con:

- **Usuario**: Qui√©n realiz√≥ la acci√≥n
- **Acci√≥n**: created, updated, deleted
- **Modelo**: Tipo de entidad afectada
- **Cambios**: JSON con los cambios realizados
- **Metadatos**: IP, User Agent, timestamp

### Soft Deletes

Todos los modelos principales implementan soft deletes:

- **Preservaci√≥n**: Los datos no se eliminan f√≠sicamente
- **Recuperaci√≥n**: Posibilidad de restaurar registros eliminados
- **Integridad**: Mantiene referencias y auditor√≠a

## üìû Soporte

Para soporte t√©cnico o preguntas sobre la implementaci√≥n:

- **Email**: developer@smartranks.com
- **Documentaci√≥n**: [Wiki del proyecto](https://github.com/smart-ranks/wiki)
- **Issues**: [GitHub Issues](https://github.com/smart-ranks/issues)

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

---

**Desarrollado con ‚ù§Ô∏è usando Laravel 12**
